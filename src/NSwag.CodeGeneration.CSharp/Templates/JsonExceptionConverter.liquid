[{{ GlobalSystemNamespaceAlias }}.CodeDom.Compiler.GeneratedCode("NSwag", "{{ ToolchainVersion }}")]
internal class JsonExceptionConverter : Newtonsoft.Json.JsonConverter
{
    private readonly Newtonsoft.Json.Serialization.DefaultContractResolver _defaultContractResolver = new Newtonsoft.Json.Serialization.DefaultContractResolver();
    private readonly {{ GlobalSystemNamespaceAlias }}.Collections.Generic.IDictionary<string, {{ GlobalSystemNamespaceAlias }}.Reflection.Assembly> _searchedNamespaces;
    private readonly bool _hideStackTrace = false;
    
    public JsonExceptionConverter()
    {
        _searchedNamespaces = new {{ GlobalSystemNamespaceAlias }}.Collections.Generic.Dictionary<string, {{ GlobalSystemNamespaceAlias }}.Reflection.Assembly> { { typeof({{ ExceptionModelClass }}).Namespace, {{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(typeof({{ ExceptionModelClass }})).Assembly } };
    }
    
    public override bool CanWrite => true;
    
    public override void WriteJson(Newtonsoft.Json.JsonWriter writer, object value, Newtonsoft.Json.JsonSerializer serializer)
    {
        var exception = value as {{ GlobalSystemNamespaceAlias }}.Exception;
        if (exception != null)
        {
            var resolver = serializer.ContractResolver as Newtonsoft.Json.Serialization.DefaultContractResolver ?? _defaultContractResolver;
    
            var jObject = new Newtonsoft.Json.Linq.JObject();
            jObject.Add(resolver.GetResolvedPropertyName("discriminator"), exception.GetType().Name);
            jObject.Add(resolver.GetResolvedPropertyName("Message"), exception.Message);
            jObject.Add(resolver.GetResolvedPropertyName("StackTrace"), _hideStackTrace ? "HIDDEN" : exception.StackTrace);
            jObject.Add(resolver.GetResolvedPropertyName("Source"), exception.Source);
            jObject.Add(resolver.GetResolvedPropertyName("InnerException"),
                exception.InnerException != null ? Newtonsoft.Json.Linq.JToken.FromObject(exception.InnerException, serializer) : null);
    
            foreach (var property in GetExceptionProperties(value.GetType()))
            {
                var propertyValue = property.Key.GetValue(exception);
                if (propertyValue != null)
                {
                    jObject.AddFirst(new Newtonsoft.Json.Linq.JProperty(resolver.GetResolvedPropertyName(property.Value),
                        Newtonsoft.Json.Linq.JToken.FromObject(propertyValue, serializer)));
                }
            }
    
            value = jObject;
        }
    
        serializer.Serialize(writer, value);
    }
    
    public override bool CanConvert({{ GlobalSystemNamespaceAlias }}.Type objectType)
    {
        return {{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(typeof({{ GlobalSystemNamespaceAlias }}.Exception)).IsAssignableFrom({{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(objectType));
    }
    
    public override object ReadJson(Newtonsoft.Json.JsonReader reader, {{ GlobalSystemNamespaceAlias }}.Type objectType, object existingValue, Newtonsoft.Json.JsonSerializer serializer)
    {
        var jObject = serializer.Deserialize<Newtonsoft.Json.Linq.JObject>(reader);
        if (jObject == null)
            return null;
    
        var newSerializer = new Newtonsoft.Json.JsonSerializer();
        newSerializer.ContractResolver = (Newtonsoft.Json.Serialization.IContractResolver){{ GlobalSystemNamespaceAlias }}.Activator.CreateInstance(serializer.ContractResolver.GetType());
    
        var field = GetField(typeof(Newtonsoft.Json.Serialization.DefaultContractResolver), "_sharedCache");
        if (field != null)
            field.SetValue(newSerializer.ContractResolver, false);
    
        dynamic resolver = newSerializer.ContractResolver;
        if ({{ GlobalSystemNamespaceAlias }}.Reflection.RuntimeReflectionExtensions.GetRuntimeProperty(newSerializer.ContractResolver.GetType(), "IgnoreSerializableAttribute") != null)
            resolver.IgnoreSerializableAttribute = true;
        if ({{ GlobalSystemNamespaceAlias }}.Reflection.RuntimeReflectionExtensions.GetRuntimeProperty(newSerializer.ContractResolver.GetType(), "IgnoreSerializableInterface") != null)
            resolver.IgnoreSerializableInterface = true;
    
        Newtonsoft.Json.Linq.JToken token;
        if (jObject.TryGetValue("discriminator", {{ GlobalSystemNamespaceAlias }}.StringComparison.OrdinalIgnoreCase, out token))
        {
            var discriminator = Newtonsoft.Json.Linq.Extensions.Value<string>(token);
            if (objectType.Name.Equals(discriminator) == false)
            {
                var exceptionType = {{ GlobalSystemNamespaceAlias }}.Type.GetType("{{ GlobalSystemNamespaceAlias }}." + discriminator, false);
                if (exceptionType != null)
                    objectType = exceptionType;
                else
                {
                    foreach (var pair in _searchedNamespaces)
                    {
                        exceptionType = pair.Value.GetType(pair.Key + "." + discriminator);
                        if (exceptionType != null)
                        {
                            objectType = exceptionType;
                            break;
                        }
                    }
    
                }
            }
        }
    
        var value = jObject.ToObject(objectType, newSerializer);
        foreach (var property in GetExceptionProperties(value.GetType()))
        {
            var jValue = jObject.GetValue(resolver.GetResolvedPropertyName(property.Value));
            var propertyValue = (object)jValue?.ToObject(property.Key.PropertyType);
            if (property.Key.SetMethod != null)
                property.Key.SetValue(value, propertyValue);
            else
            {
                field = GetField(objectType, "m_" + property.Value.Substring(0, 1).ToLowerInvariant() + property.Value.Substring(1));
                if (field != null)
                    field.SetValue(value, propertyValue);
            }
        }
    
        SetExceptionFieldValue(jObject, "Message", value, "_message", resolver, newSerializer);
        SetExceptionFieldValue(jObject, "StackTrace", value, "_stackTraceString", resolver, newSerializer);
        SetExceptionFieldValue(jObject, "Source", value, "_source", resolver, newSerializer);
        SetExceptionFieldValue(jObject, "InnerException", value, "_innerException", resolver, serializer);
    
        return value;
    }
    
    private {{ GlobalSystemNamespaceAlias }}.Reflection.FieldInfo GetField({{ GlobalSystemNamespaceAlias }}.Type type, string fieldName)
    {
        var field = {{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(type).GetDeclaredField(fieldName);
        if (field == null && {{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(type).BaseType != null)
            return GetField({{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(type).BaseType, fieldName);
        return field;
    }
    
    private {{ GlobalSystemNamespaceAlias }}.Collections.Generic.IDictionary<{{ GlobalSystemNamespaceAlias }}.Reflection.PropertyInfo, string> GetExceptionProperties({{ GlobalSystemNamespaceAlias }}.Type exceptionType)
    {
        var result = new {{ GlobalSystemNamespaceAlias }}.Collections.Generic.Dictionary<{{ GlobalSystemNamespaceAlias }}.Reflection.PropertyInfo, string>();
        foreach (var property in {{ GlobalSystemNamespaceAlias }}.Reflection.RuntimeReflectionExtensions.GetRuntimeProperties(exceptionType))
        {
            if (property.GetMethod?.IsPublic != true)
            {
                continue;
            }

            var attribute = {{ GlobalSystemNamespaceAlias }}.Reflection.CustomAttributeExtensions.GetCustomAttribute<Newtonsoft.Json.JsonPropertyAttribute>(property);
            var propertyName = attribute != null ? attribute.PropertyName : property.Name;

            switch (propertyName)
            {
                case "Message":
                case "StackTrace":
                case "Source":
                case "InnerException":
                case "Data":
                case "TargetSite":
                case "HelpLink":
                case "HResult":
                    break;
                default:
                    result[property] = propertyName;
                    break;
            }
        }
        return result;
    }
    
        private void SetExceptionFieldValue(Newtonsoft.Json.Linq.JObject jObject, string propertyName, object value, string fieldName, Newtonsoft.Json.Serialization.IContractResolver resolver, Newtonsoft.Json.JsonSerializer serializer)
        {
            var field = {{ GlobalSystemNamespaceAlias }}.Reflection.IntrospectionExtensions.GetTypeInfo(typeof({{ GlobalSystemNamespaceAlias }}.Exception)).GetDeclaredField(fieldName);
            var jsonPropertyName = resolver is Newtonsoft.Json.Serialization.DefaultContractResolver ? ((Newtonsoft.Json.Serialization.DefaultContractResolver)resolver).GetResolvedPropertyName(propertyName) : propertyName;
            foreach (var property in jObject.Properties())
            {
                if ({{ GlobalSystemNamespaceAlias }}.String.Equals(property.Name, jsonPropertyName, {{ GlobalSystemNamespaceAlias }}.StringComparison.OrdinalIgnoreCase))
                {
                    var fieldValue = property.Value.ToObject(field.FieldType, serializer);
                    field.SetValue(value, fieldValue);
                    break;
                }
            }
        }
    }
